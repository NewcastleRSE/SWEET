<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <!-- App CSS -->
    <link href="{{ url_for('static', filename='css/template.css') }}" rel="stylesheet">
    <title>HT&amp;Me</title>
  </head>
  <body>
      <div class="row">
         <div class="sidenav col-sm-3 d-none d-sm-block">
         <div class="sidebar-text d-flex flex-column min-vh-100 justify-content-center">
            <h1>Account activation</h1>
            <p>Use this page to activate your account. If you've already done this please <a href="{{url_for('auth.login')}}">login here</a>.</p>
         </div>
         </div>
         <div class="col-sm-9 col-xs-12">
         <div class="col-md-6 offset-md-1 col-lg-4 offset-lg-1 d-flex flex-column min-vh-100 justify-content-center align-items-left">
            <div class="login-form m-4">
               <img src="{{ url_for('static', filename='images/logo-1.png')}}" class="img-fluid" alt="logo" />
               <form>
                  <div class="mb-3">
                     <label>Email Address</label>
                     <input type="email" class="form-control" placeholder="Email" name="email" required>
                  </div>

                  <div class="d-grid gap-2 mt-4">
                     <button class="btn btn-primary" type="submit">Confirm Email Address</button>
                  </div>
                  <div id="error-message"></div>
               </form>
               </div>
            </div>
         </div>
      </div>
      <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
      <script type="module">
import { createModal } from "{{ url_for('static', filename='scripts/extensions/modal.js')}}"

document.querySelector("form").addEventListener("submit", e => {
   e.preventDefault(); e.stopPropagation();
   let form = e.target;
   let email = form.elements['email'];

   fetch(`/auth/confirm?email=${encodeURIComponent(email)}`).then(response => response.json())
   .then(outcome => {
      if (outcome.result == "OK") {
         let modal = createModal(true);

         modal.title.textContent = "Create Password"
         modal.body.innerHTML = `
            <form id="new-user-password">
               <h4>Welcome, ${firstName} ${lastName}</h4>
               <p>Please set your password below. Once you've created your password you'll be ready to log in to HT&amp;Me</p>
               <p id="password-errors" hidden></p>
               <div class="mb-3">
                  <label>Password</label>
                  <input type="password" class="form-control" name="password" minlength="4" title="Password must be at least 4 characters long" required>
               </div>
               <div class="mb-3">
                  <label>Confirm Password</label>
                  <input type="password" class="form-control" name="password_conf" >
               </div>
            </form>
         `
         modal.footer.innerHTML = `<button type="submit" for="new-user-password" class="btn btn-primary">Set Password</button>`

         modal.footer.querySelector("button[name='close']").addEventListener("click", () => {
            modal.hide();
         })

         modal.body.querySelector("form").addEventListener("submit", se => {
            se.preventDefault(); se.stopPropagation();

            let passform = se.target;
            if (passform.elements["password"].value != passform.elements["password_conf"].value) {
               passform.querySelector("#password-errors").textContent = "Password confirmation does not match password! Please try again.";
               return false;
            }

            fetch("/auth/activate/", {
               method: "POST",
               headers: {
                     "Content-Type": "application/json"
               },
               body: JSON.stringify({ userID: outcome.user.userID, password: passform.elements["password"].value })
            }).then(response => response.json())
            .then(result => {
               // confirm the password was set correctly then redirect to the login page.
               modal.body.innerHTML = "<h4>Password Set!</h4><p>You may now close this pop-up and <a href=\"{{ url_for('auth.login')}}\">log in to HT&amp;Me</a></p>";
               modal.footer.innerHTML = `<button type="button" class="btn btn-secondary">Close</btn>`;
               
               modal.footer.querySelector("button").addEventListener("click", () => modal.hide());
               modal.addEventListener("hidden.bs.modal", () => location.pathname = "{{url_for('auth.login')}}");
            })
         })
      } 
      else {
         document.querySelector("#error-messages").innerHTML = `<p>There was a problem confirming your email address; pleasee see the message below for details</p><p class='alert alert-primary' role='alert'>${outcome.message}</p>`;
         return false;
      }
   })
})
      </script>
   </body>
</html>